# StarryForge 开发文档 (Developer Documentation)

## 1. 系统概述 (Overview)

**StarryForge** 是一个致力于为服务器带来深度锻造体验的综合性插件。其核心愿景是让每一件装备都成为玩家的“传家宝”。插件通过引入 **基于噪声的矿脉分布**、**未鉴定矿簇**、**沉浸式锻造(QTE)** 与 **注灵系统**，构建了一个从“勘探-挖掘-鉴定-熔炼-锻打-注灵”的完整玩法闭环。

本插件大量使用 **PDC (PersistentDataContainer)** 进行数据存储，确保物品数据与原版兼容且持久化。

---

## 2. 核心架构 (Core Architecture)

项目共包含 20 个核心 Java 文件，按功能模块划分如下：

### 2.1 核心组件 (Core Components)
| 类文件 | 职责 |
| :--- | :--- |
| `StarryForge.java` | **插件入口**。负责所有管理器 (`Manager`) 的初始化、事件监听器注册以及命令注册。 |
| `ConfigManager.java` | **配置管理**。负责 `config.yml` 与 `messages.yml` 的加载、热重载以及多语言消息的获取。 |
| `PDCManager.java` | **数据持久化工具**。封装了 PDC (PersistentDataContainer) 的常用操作，如温度读写、自定义 ID 读写。 |
| `AntiExploitListener.java` | **防刷机制**。通过 Metadata 标记玩家放置的方块，防止玩家通过“放置-挖掘”循环刷取矿簇。 |
| `DebugStickManager.java` | **调试工具**。实现“调试棒”功能，用于查看方块坐标、物品 PDC 数据以及测试噪声强度。 |

### 2.2 物品与资源 (Items & Resources)
| 类文件 | 职责 |
| :--- | :--- |
| `SFItemManager.java` | **物品工厂**。统一管理所有自定义物品（矿簇、谐振仪、机器等）的创建、注册与识别。 |
| `Keys.java` | **常量定义**。集中管理所有的 `NamespacedKey` 常量，避免硬编码字符串。 |

### 2.3 矿脉与挖掘 (Mining & Veins)
| 类文件 | 职责 |
| :--- | :--- |
| `NoiseManager.java` | **噪声核心**。基于 Perlin Noise 实现 3D 隐式矿脉场，计算任意坐标的矿脉潜力值。 |
| `MiningManager.java` | **挖掘逻辑**。处理挖掘相关的概率计算、掉落判定以及群系修正。 |
| `GlobalDropListener.java` | **挖掘监听**。监听 `BlockBreakEvent`，调用 `MiningManager` 判定是否掉落未知矿簇。 |
| `LithicInsightEnchantment.java` | **自定义附魔**。实现“岩层勘探”附魔的注册、应用（Lore构建）以及等级获取逻辑。 |

### 2.4 勘探系统 (Resonator System)
| 类文件 | 职责 |
| :--- | :--- |
| `ResonatorManager.java` | **谐振仪核心**。处理地质谐振仪的扫描逻辑、ActionBar 反馈以及音效播放。 |
| `ResonatorListener.java` | **交互监听**。监听玩家使用谐振仪的行为（右键激活/关闭），并触发扫描任务。 |

### 2.5 洗矿系统 (Sluice System)
| 类文件 | 职责 |
| :--- | :--- |
| `SluiceManager.java` | **洗矿台逻辑**。**[核心]** 处理矿簇清洗、进度更新、离线结算以及 Force Refresh 状态同步。 |
| `SluiceListener.java` | **机器监听**。处理洗矿台的放置、破坏以及玩家打开 GUI 的交互事件。 |

### 2.6 合金与锻造 (Alloy & Forging)
| 类文件 | 职责 |
| :--- | :--- |
| `AlloyManager.java` | **合金高炉逻辑**。处理多方块结构检测、熔炼会话 (`SmeltingSession`)、温控 QTE 与爆炸判定。 |
| `ThermodynamicsManager.java` | **热力学模拟**。全局任务，处理物品栏中物品的自然冷却以及高温物品对玩家的灼烧伤害。 |
| `AnvilListener.java` | **铁砧增强**。处理自定义附魔（如岩层勘探）在铁砧上的合并与应用逻辑。 |

### 2.7 多方块结构 (Multiblocks)
| 类文件 | 职责 |
| :--- | :--- |
| `MultiBlockManager.java` | **结构管理器**。负责从配置加载结构定义，并提供结构检测与调试功能。 |
| `StructurePattern.java` | **结构模型**。表示一个 3D 多方块结构模式，支持基于字符矩阵的匹配与旋转检测。 |

---

## 3. 详细模块解析 (Detailed Module Analysis)

### 3.1 核心矿脉与噪声系统 (`NoiseManager.java`)

StarryForge 摒弃了传统的“生成真实方块”的矿脉做法，而是采用 **隐式场 (Implicit Field)** 的概念。

*   **原理**: 使用 Perlin Noise 算法，根据世界种子生成一个遍布地下的 3D 噪声场。
*   **计算**: 
    *   输入: `(x, y, z)` 坐标。
    *   输出: `0.0` ~ `1.0` 的潜力值 (`potency`)。
*   **特性**:
    *   **非破坏性**: 不修改任何地形数据，仅在逻辑层判定。
    *   **确定性**: 只要种子不变，同一个坐标的计算结果永远一致。
    *   **动态性**: 可以在任何时候调整算法参数，无需重置地图。

### 3.2 勘探与挖掘系统 (`ResonatorListener` & `GlobalDropListener`)

#### 3.2.1 地质谐振仪 (Seismic Resonator)
*   **物品**: 指南针 (CustomModelData: 1002)
*   **交互**: 右键激活/关闭。
*   **反馈机制**:
    *   **听觉**: 模拟盖革计数器/雷达。信号越强（靠近核心矿脉），音效频率越高、音调越急促。
    *   **视觉 (ActionBar)**: 显示伪装成物理参数的读数（如磁场强度 `μT`、相位 `φ`），增强沉浸感。
    *   **逻辑**: 每 40 ticks (2秒) 扫描一次玩家所在位置的噪声值。

#### 3.2.2 全局掉落 (Global Drops)
*   **触发**: 玩家挖掘特定方块（石头、深板岩、矿石等）。
*   **判定流程**:
    1.  **有效性检查**: 是否为自然生成的方块？是否持有附魔工具？
    2.  **概率判定**: 基础概率 + 附魔加成 + 谐振仪加成。
    3.  **品质计算**: 调用 `NoiseManager` 获取当前位置的矿脉潜力，结合群系类型（富集/贫瘠），计算出矿簇的 **品质 (Quality)**。
    4.  **掉落**: 生成带有 `cluster_quality` NBT 数据的“未知矿簇”。

#### 3.2.3 掉落分布表 (Drop Distribution Table)
为了确保挖掘的收益平衡，系统定义了严格的掉落分布。

**1. 矿簇掉落概率 (Cluster Drop Rate)**
*   **基础概率**: **0%** (普通挖掘不会掉落)
*   **触发条件**: 必须附魔 **"岩层勘探" (Lithic Insight)**。
    *   **附魔获取**: 通过特定的附魔书在铁砧上通过原版方式附魔。
    *   **视觉效果**: 赋予镐子原版附魔光效 (Glint)。
*   **附魔概率**:
    *   I 级: 10%
    *   II 级: 15%
    *   III 级: 20%
*   **方块类型修正**:
    *   矿石类: 100% 附魔概率
    *   岩石类 (石头/深板岩): 10% * 附魔概率 (即 1% - 2%)
*   **谐振仪加成**:
    *   当 **地质谐振仪** 处于激活状态 且 位于 **强信号区 (Potency > 0.8)** 时。
    *   概率加成: **+50%** (乘法叠加，例如 III 级变为 30%)。
*   **反馈机制**:
    *   **发现反馈**: 成功掉落矿簇时，播放 `ENTITY_EXPERIENCE_ORB_PICKUP` 音效并在方块位置生成 `ENCHANT` 粒子。
    *   **防刷机制**:
    *   仅限 **自然生成** 的方块。玩家放置的方块 (即使是矿石) 挖掘后不会掉落矿簇。
    *   **不吃精准采集**: 精准采集挖掘不影响判定，但矿簇只能来源于第一手挖掘。

**2. 矿簇品质分布 (Cluster Quality Distribution)**
矿簇品质 (`cluster_quality`) 决定了洗矿后产出高星级矿物的概率。
品质值范围：`0 - 100`。

| 条件 | 噪声潜力 (Potency) | 平均品质 | 备注 |
| :--- | :--- | :--- | :--- |
| **贫瘠区** (Poor Biome) | 0.0 - 0.3 | 10 - 30 | 几乎全是碎屑 |
| **贫瘠区** (Poor Biome) | 0.3 - 0.7 | 20 - 40 | 低品质 |
| **贫瘠区** (Poor Biome) | > 0.7 (Core) | 40 - 60 | 偶尔有惊喜 |
| **普通区** (Normal) | 0.0 - 0.3 | 20 - 40 | 正常水平 |
| **普通区** (Normal) | 0.3 - 0.7 | 40 - 60 | 较好 |
| **普通区** (Normal) | > 0.7 (Core) | 60 - 80 | 优质矿簇 |
| **富集区** (Rich Biome) | 0.0 - 0.3 | 40 - 60 | 起步较高 |
| **富集区** (Rich Biome) | 0.3 - 0.7 | 60 - 80 | 极高品质 |
| **富集区** (Rich Biome) | > 0.7 (Core) | **80 - 100** | **传说级矿簇** |

### 3.3 洗矿系统 (`SluiceManager`)

#### 3.3.1 核心机制
*   **GUI 设计**: 27格容器界面 (Chest 3 Rows)。
    *   **输入端**: 左侧区域，用于放置未知矿簇。
    *   **输出端**: 右侧区域，产出鉴定后的矿物。
    *   **溶剂槽**: 指定槽位，放置 **星辉溶剂 (Starry Solvent)**。
    *   **进度条**: 中间区域，显示当前洗矿进度。
    *   **装饰**: 其余空白槽位由黑色玻璃板填充。
*   **数据持久化**: 容器内的物品数据通过 PDC 存储，服务器重启或插件重载不会丢失。
*   **处理逻辑**:
    *   **耗时**: 根据矿簇的隐藏星级决定。1星约 3s，5星约 20s。
    *   **离线处理**: 玩家关闭 GUI 后，后台继续处理。
*   **技术亮点**:
    *   **Force Refresh 模式**: 针对 Bukkit 的 `BlockState` 快照机制，实现了强制刷新逻辑，确保在 Live GUI 和离线计算之间的数据一致性。
    *   **事务性保存**: 物品变动仅在必要时保存，避免不必要的 I/O 开销。

#### 3.3.2 产出逻辑 (Loot Generation)
*   **星级判定**:
    *   基于矿簇品质 (`quality`) 随机生成矿物星级 (1-5星)。
    *   星级显示统一格式: `★★★☆☆` (与耕食记/牧野之歌保持一致)。
*   **矿物类型**:
    *   **原版矿物**: 煤炭、铁、铜、金、红石、青金石、钻石、绿宝石。
    *   **特产矿物**: 来自 BiomeGifts 的特殊矿物 (如 Lignite, Rich Slag 等)。
*   **概率分布**:
    *   **基础**: 60% 原版矿物 : 40% 特产矿物。
    *   **使用溶剂**: 50% 原版矿物 : 50% 特产矿物 (且品质 +15)。
*   **反馈机制**:
    *   **3星及以上**: 播放 `BLOCK_AMETHYST_BLOCK_CHIME` 音效与 `WAX_ON` 粒子。
    *   **5星 (传说)**: 播放 `UI_TOAST_CHALLENGE_COMPLETE` 尊贵音效，生成 `HAPPY_VILLAGER` 粒子，并向周围 (10格内) 玩家发送尊贵提示信息（非全服通告）。

**星级概率表 (Star Rating Probability)**:

| 矿簇品质 (Quality) | 1星 (Trash) | 2星 (Common) | 3星 (Rare) | 4星 (Epic) | 5星 (Legendary) |
| :--- | :---: | :---: | :---: | :---: | :---: |
| **0 - 20** | 80% | 15% | 5% | 0% | 0% |
| **21 - 40** | 50% | 35% | 14% | 1% | 0% |
| **41 - 60** | 30% | 40% | 25% | 4% | 1% |
| **61 - 80** | 10% | 30% | 40% | 15% | 5% |
| **81 - 100** | 0% | 10% | 30% | 40% | **20%** |

### 3.2.4 原矿与特产矿星级 (Ore & Specialty Star Rating)

为了统一资源品质体系，直接挖掘获得的原矿（如煤炭、原铜等）以及由 `BiomeGifts` 产出的特产矿物（如褐煤、富矿渣）现在也拥有星级系统。

*   **计算逻辑**:
    *   **群系影响**: 调用 `BiomeGifts` 的 API 判断当前群系类型（富集/贫瘠/普通）。
    *   **噪声叠加**: 结合 `NoiseManager` 的潜力值 (`potency`)。
    *   **星级公式**: `Stars = (ClusterQuality / 20) + 1` (Min 1, Max 5)。

*   **星级分布表 (Ore Star Distribution)**:
    根据群系与地质噪声的强弱，直接挖掘获得的矿物星级分布如下：

    | 噪声强度 | 贫瘠区 (Poor) | 普通区 (Normal) | 富集区 (Rich) |
    | :--- | :--- | :--- | :--- |
    | **弱 (< 0.3)** | 1★ - 2★ | 2★ - 3★ | 3★ - 4★ |
    | **中 (0.3 - 0.7)** | 2★ - 3★ | 3★ - 4★ | 4★ - 5★ |
    | **强 (> 0.7)** | 3★ - 4★ | 4★ - 5★ | **5★ (Legendary)** |

*   **视觉表现**:
    *   **星级显示**: 物品 Lore 第一行显示星级：`§e★★★☆☆`。
    *   **名字颜色**:
        *   **原版物品** (如煤炭、铁矿): 名字颜色随星级变化 (绿->蓝->紫->黄->金)。
        *   **特产物品** (如特产矿、特产畜牧产品): 名字颜色固定为 **金色 (§6)**，仅星级Lore变化。
    *   **数据存储**: 星级数据存储于 PDC (`ore_star_rating`)，支持通过洗矿台产出保留。
    *   **设计归档**: 详细视觉规范已归档至 `.trae/rules/mc-resource-artist/references/rpg-tier-visuals.md`。

*   **洗矿产出**:
    *   洗矿台产出的矿物星级不再是 1:1 复制矿簇星级，而是基于矿簇品质进行 **概率分布** (Probability Distribution)，使得高星矿簇有概率开出低星矿物（虽然概率很低），反之亦然（低星极小概率爆高星），增加了玩法的随机性与期待感。

### 3.4 物品数据结构 (`SFItemManager.java`)

所有自定义物品均通过 `SFItemManager` 统一注册与管理。

*   **识别键**: `sf_item_id` (PDC String)
*   **数据存储**:
    *   **未知矿簇**:
        *   `cluster_quality` (Integer): 决定洗矿后的产出星级期望。
    *   **精炼物**:
        *   `temperature` (Double): 当前温度，存储在 PDC 中，用于热力学计算。

### 3.5 合金冶炼系统 (`AlloyManager`)

合金冶炼是获取高级材料的关键步骤，采用创新的 **热力冲程 (Thermal Stroke)** 交互机制。

#### 3.5.1 合金高炉结构 (Alloy Blast Furnace)
*   **尺寸**: 3x3x3 实心结构。
*   **材料**:
    *   **核心**: 高炉 (Blast Furnace)，位于中心 (1,1,1)。
    *   **交互口**: 锻造台 (Smithing Table)，位于侧面中心。
    *   **框架**: 深板岩瓦 (Deepslate Tiles)、磨制深板岩 (Polished Deepslate)。
    *   **热源**: 岩浆块 (Magma Block)，位于底部中心。
*   **构建**: 使用 `MultiBlockManager` 进行 3D 结构检测。支持结构旋转（东/南/西/北）。

#### 3.5.2 热力冲程机制 (Thermal Stroke Mechanics)
摒弃了传统的 GUI 读条，采用沉浸式的世界交互与动态物理模拟。

*   **交互流程**:
    1.  **投料**: 右键打开 GUI (仅作容器)，放入矿物与 **助熔剂 (Flux)**，点击点火。
    2.  **升温冲程**: 炉子轰鸣，ActionBar 显示温度计 `[❄️ ---|==★==|--- 🔥]`。
    3.  **动态博弈**:
        *   **鼓风 (右键结构)**: 温度指针向右加速 (升温)。
        *   **阻尼 (潜行)**: 增加阻力，使指针减速/稳定 (控温)。
        *   **锻打 (左键结构)**: 当指针位于 **甜蜜点 (★)** 时，左键敲击炉体定型。
    4.  **循环**: 成功敲击 5 次后完成熔炼。

*   **助熔剂策略 (Flux)**:
    *   **煤炭**: 标准手感，适合新手。
    *   **烈焰粉**: 升温极快，甜蜜点宽，适合追求速度的高手。
    *   **粘液球**: 惯性大，极难改变温度方向，但极其稳定，适合精准控温。

*   **风险控制**:
    *   **炸炉**: 若温度进入红色危险区超过 3秒，炉子爆炸，结构损毁，材料消失。
    *   **急救**: 投掷水瓶可强制降温，但会导致成品品质极低。

*   **星级公式**:
    *   `最终星级 = 原材料星级 * (0.5 + 0.5 * QTE完成率)`
    *   **减法逻辑**: 原材料决定上限，操作决定是否能达到上限。

### 3.6 热力学系统 (`ThermodynamicsManager`)

模拟真实的物理热力学效果，增加生存挑战。

*   **物品冷却**:
    *   物品栏中的高温物品会随时间自然冷却 (基于牛顿冷却定律)。
    *   冷却速率受环境温度影响。
*   **玩家互动**:
    *   **灼烧**: 当物品栏中有超过 **100°C** 的物品时，玩家将持续受到火焰伤害。
    *   **警示**: ActionBar 会显示高温警示。
    *   **Lore 更新**: 物品 Lore 实时更新当前温度显示 (颜色随温度变化: 白->黄->金->红)。

### 3.7 多方块结构系统 (`MultiBlockManager` & `StructurePattern`)

为了支持复杂的机器结构，插件实现了一套通用的 3D 结构检测系统。

*   **配置驱动**: 结构定义在 `config.yml` 中，使用字符矩阵表示。
*   **3D 矩阵**: 使用 `String[][] layers` 定义每一层 (Layer) 的方块布局。
*   **旋转检测 (`StructurePattern.java`)**:
    *   **原理**: 结构定义默认为面向北 (North)。检测时，系统会尝试将定义的相对坐标 (relX, relZ) 绕核心方块旋转 (0°, 90°, 180°, 270°)。
    *   **向量变换**: `rotate()` 方法根据 `BlockFace` 动态计算新的世界坐标偏移量，确保玩家无论朝向何处构建都能被识别。
*   **可视化调试**:
    *   提供 `debugStructure` 方法。当结构不完整时，会计算“最小差异”方向，并使用粒子效果 (`Particle.DUST`) 高亮显示错误或缺失的方块位置，极大降低了玩家的搭建门槛。

### 3.8 辅助核心组件 (Auxiliary Core Components)

#### 3.8.1 防刷机制 (`AntiExploitListener`)
为了维护经济平衡，防止玩家通过“放置-挖掘”循环无限刷取矿簇。
*   **实现**: 监听 `BlockPlaceEvent`。
*   **标记**: 为玩家放置的方块添加临时的 Metadata (`SF_PLACED_BLOCK`)。
*   **判定**: 挖掘时检查该 Metadata。若存在，则视为“非自然生成”，不触发矿簇掉落判定。
*   **注意**: Metadata 在服务器重启后失效，但这足以防御即时的刷取行为。

#### 3.8.2 铁砧附魔逻辑 (`AnvilListener`)
由于原版铁砧逻辑不支持自定义附魔书的直接应用，插件接管了 `PrepareAnvilEvent`。
*   **冲突解决**: 允许将带有 `Lithic Insight` 自定义附魔的书籍与镐子合并。
*   **等级计算**: 遵循原版附魔叠加规则 (I + I = II, I + II = II)。
*   **PDC 传递**: 确保附魔等级作为数据写入结果物品的 PDC，而不仅仅是 Lore。

#### 3.8.3 数据持久化 (`PDCManager`)
*   **类型安全**: 封装了 `PersistentDataContainer` 的底层操作，提供 `setInt`, `setDouble`, `setString` 等强类型方法。
*   **统一管理**: 避免了在各个业务逻辑中重复编写 PDC 读写代码，降低了出错概率。

---

## 4. 开发规范 (Conventions)

*   **PDC 优先**: 任何需要持久化的数据（如物品属性、机器状态）必须存入 PDC，严禁依赖 Lore 解析。请使用 `PDCManager` 进行操作。
*   **生命周期安全 (Lifecycle Safety)**: 
    *   机器状态必须能够抵抗服务器重启、区块卸载。
    *   使用 **事务性保存** 确保数据不丢失。
    *   参考 `.trae/rules/mc-modern-stack/references/lifecycle-safety.md`。
*   **模块化**: 每个子系统（如 Mining, Alloy）应有独立的包与管理器。
*   **常量管理**: 所有的 NBT Key、ModelData ID 应在 `SFItemManager` 中定义常量。
*   **交互反馈**: 所有的玩家交互都应有明确的音效与视觉反馈（ActionBar/Title/Particle）。
*   **国际化 (I18n)**: 必须同时维护 `zh_CN` 与 `en_US` 语言文件。严格遵循 `mc-config-architect` 规范，禁止在代码中硬编码文本。

### 3.9 星魂共振锻造 (`ForgingManager`)

星魂共振锻造 (Astral Resonance Forging) 是继合金冶炼后的高阶制造系统，用于打造传说级武器与神器。

#### 3.9.1 星魂共振台 (Astral Forge Node)
*   **核心方块**: 锻造台 (Smithing Table)
*   **多方块结构**:
    *   **底层**: 3x3 抛光深板岩 (Polished Deepslate)。作为稳固的能量底座。
    *   **顶层中心**: 锻造台 (核心)。
    *   **顶层四角**: 深板岩砖墙 (Deepslate Brick Wall)。作为星能导流柱，采用围墙设计以增加通透感。
*   **交互逻辑**:
    *   **放置蓝图 (空白蓝图)**:
        *   手持空白蓝图 (`BLANK_BLUEPRINT`) 右键星魂共振台。
        *   **重要**: 只有通过右键星魂台打开的 GUI 才能选定锻造目标。直接右键空气无效。
        *   选择后手中的空白蓝图变成"工程蓝图"（带附魔光效），关闭 GUI。
    *   **铺展蓝图 (工程蓝图)**:
        *   手持工程蓝图右键星魂台，蓝图被消耗，铺展在台上。
        *   祭坛上方出现 ItemDisplay 全息投影。
    *   **取出蓝图**:
        *   **无进度时**: 空手 Shift+右键 即可取回蓝图。
        *   **有进度时**: 空手 Shift+右键 会触发警告，5秒内再次 Shift+右键 确认取出，否则自动取消。取出后锻造进度丢失。
        *   空手普通右键仅显示当前进度信息 (ActionBar)。
    *   **放置材料**: 蓝图铺展后，手持符合要求的红热材料右键核心，材料模型浮空显示。
    *   **锻打 (QTE)**:
        *   手持 **锻造锤 (Forging Hammer)** 左键点击核心。
        *   **节奏判定**: 玩家需要在星尘粒子汇聚的瞬间进行敲击（视觉/听觉提示）。
        *   **锤子等级**: 不同神器需要不同等级 (T1/T2/T3) 的锤子才能锻造。

#### 3.9.2 视觉特效系统 (`ForgingVisuals`)
*   **全息投影**: 使用 `ItemDisplay` 在祭坛上方悬浮显示当前锻造的目标成品，随锻造进度旋转。
*   **星尘粒子**: 使用 `BlockDisplay` (微型光块) 模拟星尘向中心汇聚的动态效果。
    *   **红色星尘**: 错误/未命中。
    *   **金色星尘**: 完美命中。
*   **反馈**: 每次敲击伴随金属撞击声与火花粒子，锻造完成后播放史诗级音效与冲击波效果。

#### 3.9.3 物品体系
*   **锻造锤**: 分为 T1 (铁), T2 (钻), T3 (星陨/合金) 三级。高级配方需要高级锤。
*   **蓝图**:
    *   **空白蓝图**: 消耗品，右键祭坛选择配方。
    *   **工程蓝图**: 绑定了特定配方的蓝图，带有耐久度 (虽然不会损耗，仅作视觉区分)。
*   **神器 (Artifacts)**:
    *   **泰坦重锤**: T3 级锻造工具，拥有极高的品质加成。
    *   **星陨重甲**: 提供高额护甲与击退抗性。
    *   **狱火神兵**: 附带火焰伤害的神话武器。
